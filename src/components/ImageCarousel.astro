---
interface Props {
  images: string[];
  alt: string;
}

const { images, alt } = Astro.props;
---

<div class="carousel relative w-full h-72 group overflow-hidden rounded-t-xl bg-gray-900">
  <div class="carousel-track flex transition-transform duration-500 ease-in-out h-full w-full">
    {images.map((img, index) => (
      <img
        src={img}
        alt={`${alt} - Imagen ${index + 1}`}
        class="w-full h-full object-cover object-top-left shrink-0 cursor-default lg:cursor-zoom-in"
        loading="lazy"
      />
    ))}
  </div>

  <button class="carousel-zoom-btn absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full lg:hidden focus:outline-none z-10 cursor-pointer" aria-label="Ampliar imagen">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
    </svg>
  </button>

  {images.length > 1 && (
    <>
      <button class="carousel-prev absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity focus:outline-none z-10 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </button>
      <button class="carousel-next absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity focus:outline-none z-10 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
      </button>
    </>
  )}

  <dialog class="carousel-zoom-dialog bg-transparent p-0 backdrop:bg-black/90 w-screen h-screen max-w-none max-h-none m-0 border-none outline-none">
    <div class="zoom-container relative w-full h-full flex items-center justify-center">
      <button class="close-zoom absolute top-4 right-4 text-white hover:text-gray-300 z-50 focus:outline-none cursor-pointer p-2 bg-black/50 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      <img src="" alt="Zoomed Image" class="zoomed-image max-w-[95%] max-h-[95%] object-contain shadow-2xl rounded-md" />
    </div>
  </dialog>
</div>

<script>
  function initCarousels() {
    const carousels = document.querySelectorAll('.carousel');
    
    carousels.forEach(carousel => {
      const track = carousel.querySelector('.carousel-track') as HTMLElement;
      const prevBtn = carousel.querySelector('.carousel-prev');
      const nextBtn = carousel.querySelector('.carousel-next');
      const images = track?.querySelectorAll('img');
      const zoomBtn = carousel.querySelector('.carousel-zoom-btn');

      // Elementos del Zoom
      const dialog = carousel.querySelector('.carousel-zoom-dialog') as HTMLDialogElement;
      const zoomedImage = dialog?.querySelector('.zoomed-image') as HTMLImageElement;
      const closeBtn = dialog?.querySelector('.close-zoom');
      const zoomContainer = dialog?.querySelector('.zoom-container');
      
      if (!track || !images) return;
      
      let currentIndex = 0;

      // L칩gica del Zoom
      if (dialog && zoomedImage) {
        images.forEach(img => {
          img.addEventListener('click', () => {
            if (window.matchMedia('(min-width: 1024px)').matches) {
              zoomedImage.src = img.src;
              zoomedImage.alt = img.alt;
              dialog.showModal();
            }
          });
        });
        
        zoomBtn?.addEventListener('click', (e) => {
          e.stopPropagation();
          const img = images[currentIndex];
          if (img) {
            zoomedImage.src = img.src;
            zoomedImage.alt = img.alt;
            dialog.showModal();
          }
        });

        const closeDialog = () => {
             dialog.close();
        };

        closeBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            closeDialog();
        });

        dialog.addEventListener('click', (e) => {
            // Cerrar si se hace clic fuera de la imagen
            if (e.target === dialog || e.target === zoomContainer) {
                closeDialog();
            }
        });
      }

      // L칩gica del Carrusel (solo si hay m치s de 1 imagen)
      if (images.length > 1) {
          const updateCarousel = () => {
              track.style.transform = `translateX(-${currentIndex * 100}%)`;
          };

          prevBtn?.addEventListener('click', (e) => {
              e.stopPropagation();
              currentIndex = (currentIndex === 0) ? images.length - 1 : currentIndex - 1;
              updateCarousel();
          });

          nextBtn?.addEventListener('click', (e) => {
              e.stopPropagation();
              currentIndex = (currentIndex === images.length - 1) ? 0 : currentIndex + 1;
              updateCarousel();
          });
      }
    });
  }

  // Ejecutar al cargar la p치gina
  initCarousels();
  
  // Soporte para View Transitions de Astro (si se usan en el futuro)
  document.addEventListener('astro:after-swap', initCarousels);
</script>