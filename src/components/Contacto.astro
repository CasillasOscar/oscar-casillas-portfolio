---
const { id } = Astro.props;
// Capturamos el ID secreto inyectado en el build de GitHub Actions
const formId = import.meta.env.PUBLIC_FORM_ID;
---

<section id={id}>
  <h2 class="text-2xl font-semibold text-heading mb-3">
    Contacto
  </h2>

  <form id="contact-form" class="w-full max-w-2xl flex flex-col gap-6 bg-white/5 p-6 rounded-2xl border-2 border-gray-600 backdrop-blur-sm hover:border-[#A855F7] transition-border duration-300">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="flex flex-col gap-2">
        <label for="name" class="text-sm font-medium text-gray-300">Nombre</label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Nombre"
          class="bg-gray-950/50 border border-gray-700 text-white text-sm rounded-lg focus:ring-[#A855F7] focus:border-[#A855F7] block w-full p-3 placeholder-gray-500 transition-colors outline-none"
          required
        />
      </div>
      <div class="flex flex-col gap-2">
        <label for="email" class="text-sm font-medium text-gray-300">Email</label>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="correo@email.com"
          class="bg-gray-950/50 border border-gray-700 text-white text-sm rounded-lg focus:ring-[#A855F7] focus:border-[#A855F7] block w-full p-3 placeholder-gray-500 transition-colors outline-none"
          required
        />
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <label for="subject" class="text-sm font-medium text-gray-300">Asunto</label>
      <input
        type="text"
        id="subject"
        name="subject"
        placeholder="Asunto del mensaje"
        class="bg-gray-950/50 border border-gray-700 text-white text-sm rounded-lg focus:ring-[#A855F7] focus:border-[#A855F7] block w-full p-3 placeholder-gray-500 transition-colors outline-none"
        required
      />
    </div>

    <div class="flex flex-col gap-2">
      <label for="message" class="text-sm font-medium text-gray-300">Mensaje</label>
      <textarea
        id="message"
        name="message"
        rows="5"
        placeholder="Escribe tu mensaje aquí..."
        class="bg-gray-950/50 border border-gray-700 text-white text-sm rounded-lg focus:ring-[#A855F7] focus:border-[#A855F7] block w-full p-3 placeholder-gray-500 resize-none transition-colors outline-none"
        required
      ></textarea>
    </div>

    <div class="hidden" aria-hidden="true">
      <label for="b_field">No rellenar si eres humano</label>
      <input type="text" id="b_field" name="b_field" tabindex="-1" autocomplete="off" />
    </div>

    <button
      id="submit-btn"
      type="submit"
      class="text-white bg-[#8446b1] hover:bg-[#A855F7] focus:ring-4 focus:outline-none focus:ring-purple-900 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-all duration-300 cursor-pointer self-end disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Enviar
    </button>
  </form>

  <dialog id="feedback-modal" class="bg-transparent p-0 backdrop:bg-black/80 w-[90%] max-w-md m-auto border-none outline-none rounded-2xl">
    <div class="bg-[#181a1b] border border-gray-700 rounded-2xl p-6 flex flex-col gap-4 shadow-2xl">
      <h3 id="modal-title" class="text-xl font-bold text-white"></h3>
      <p id="modal-message" class="text-gray-300"></p>
      <button id="close-modal-btn" class="text-white bg-[#8446b1] hover:bg-[#A855F7] focus:ring-4 focus:outline-none focus:ring-purple-900 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-300 cursor-pointer self-end">
        Cerrar
      </button>
    </div>
  </dialog>
</section>

<script define:vars={{ formId }}>
  const form = document.getElementById("contact-form");
  const btn = document.getElementById("submit-btn");
  const modal = document.getElementById("feedback-modal");
  const modalTitle = document.getElementById("modal-title");
  const modalMessage = document.getElementById("modal-message");
  const closeModalBtn = document.getElementById("close-modal-btn");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    if (formData.get("b_field")) return;

    btn.disabled = true;
    btn.innerText = "Enviando...";

    try {
      const response = await fetch(`https://formspree.io/f/${formId}`, {
        method: "POST",
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        showModal("¡Mensaje enviado!", "Gracias por contactar conmigo. Te responderé lo antes posible.");
        form.reset();
      } else {
        showModal("Error", "Hubo un problema al enviar el mensaje. Por favor, inténtalo de nuevo más tarde.");
      }
    } catch (error) {
      showModal("Error de conexión", "No se pudo conectar con el servidor. Verifica tu conexión a internet.");
    } finally {
      btn.disabled = false;
      btn.innerText = "Enviar";
    }
  });

  function showModal(title, message) {
    if (modal && modalTitle && modalMessage) {
      modalTitle.innerText = title;
      modalMessage.innerText = message;
      modal.showModal();
    }
  }

  closeModalBtn?.addEventListener("click", () => {
    modal?.close();
  });

  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.close();
    }
  });
</script>